name: CI
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
        with:
          version: 10
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint
      
      - name: Check work file placeholders
        run: |
          set -e
          missing=$(grep -R --line-number "<PLACEHOLDER>" docs/*.md || true)
          for file in $missing; do
            echo "â›” PLACEHOLDER ë‚¨ìŒ â†’ $file"
          done
          if [ -n "$missing" ]; then exit 1; fi
          echo "âœ… ìž‘ì—… íŒŒì¼ ê²€ì¦ í†µê³¼"
          
      - name: Check work file format
        run: |
          echo "ðŸ” ìž‘ì—… íŒŒì¼ í˜•ì‹ ê²€ì¦..."
          
          # SINGLE_FILE_V1 í…œí”Œë¦¿ íŒŒì¼ ì¡´ìž¬ í™•ì¸
          if [ ! -f "docs/_templates/SINGLE_FILE_V1.md" ]; then
            echo "âŒ SINGLE_FILE_V1 í…œí”Œë¦¿ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: docs/_templates/SINGLE_FILE_V1.md"
            exit 1
          fi
          
          # ìž‘ì—… íŒŒì¼ë“¤ì˜ í…œí”Œë¦¿ ë²„ì „ í™•ì¸
          work_files=$(find docs/ -name "*_WORK.md" 2>/dev/null || true)
          
          # SINGLE_FILE_V1 í…œí”Œë¦¿ ë²„ì „ ì²´í¬
          if [ -n "$work_files" ]; then
            for file in $work_files; do
              if [ -f "$file" ] && ! grep -q "TEMPLATE_VERSION: SINGLE_FILE_V1" "$file"; then
                echo "âŒ $file íŒŒì¼ì— SINGLE_FILE_V1 í…œí”Œë¦¿ ë²„ì „ì´ ì—†ìŠµë‹ˆë‹¤."
                exit 1
              fi
            done
          fi
          
          if [ -n "$work_files" ]; then
            echo "ë°œê²¬ëœ ìž‘ì—… íŒŒì¼ë“¤:"
            echo "$work_files"
            
            for file in $work_files; do
              if [ -f "$file" ]; then
                # í•„ìˆ˜ ì„¹ì…˜ ì²´í¬
                for section in "## 1. ê¸°ì¡´ ì§€ì‹œ" "## 2. ê³„íš" "## 3. ìž‘ì—… ë‚´ìš©" "## 4. í•µì‹¬ ì½”ë“œ ìŠ¤ëƒ…ìƒ·" "## 5. ê¸°íƒ€" "## 6. ë‹¤ìŒ ë‹¨ê³„"; do
                  if ! grep -q "$section" "$file"; then
                    echo "âŒ $file íŒŒì¼ì— '$section' ì„¹ì…˜ì´ ì—†ìŠµë‹ˆë‹¤."
                    exit 1
                  fi
                done
              fi
            done
          fi
          
          echo "âœ… ìž‘ì—… íŒŒì¼ í˜•ì‹ ê²€ì¦ í†µê³¼"

  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
        with:
          version: 10
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm test
      - run: pnpm test:coverage

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Increased for Tailwind build
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
        with:
          version: 10
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      
      - name: Build with metrics
        run: |
          echo "::group::Build Metrics"
          START_TIME=$(date +%s)
          
          # Build all packages
          pnpm build
          
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          
          echo "Total build time: ${BUILD_TIME}s"
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          
          # Check Tailwind build time from logs
          if [ -f "apps/web/.next/trace" ]; then
            echo "Next.js build trace available"
          fi
          echo "::endgroup::"
        id: build-metrics
      
      - name: Report metrics
        if: always()
        run: |
          echo "### Build Metrics ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "- Total build time: ${{ steps.build-metrics.outputs.build_time }}s" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
      
  e2e:
    name: E2E Tests
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
        with:
          version: 10
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm playwright install --with-deps
      - run: pnpm playwright test --reporter=list
      - uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
      
  smoke-test:
    name: Smoke Test
    needs: [build, e2e]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
        with:
          version: 10
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - run: ./scripts/quick-test.sh